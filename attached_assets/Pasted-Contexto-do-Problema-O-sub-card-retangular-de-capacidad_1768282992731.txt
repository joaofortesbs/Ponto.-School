Contexto do Problema
O sub-card retangular de capacidade gerar_conteudo_atividades n√£o est√° sendo renderizado ap√≥s a conclus√£o da Interface de Constru√ß√£o de Atividades. A IA est√° pulando diretamente para o card de explica√ß√£o do t√≥pico, ignorando completamente a etapa 4 do plano de execu√ß√£o.

Diagn√≥stico T√©cnico
Baseado na an√°lise do c√≥digo e hist√≥rico de commits, identifiquei 3 falhas cr√≠ticas no fluxo:

Falha no Sistema de Eventos: O ConstructionInterface.tsx emite o evento construction:all_completed, mas o DeveloperModeCard.tsx n√£o est√° capturando e processando corretamente este evento para acionar a pr√≥xima capability.

Falha na Sequ√™ncia de Execu√ß√£o: A etapa 4 (gerar_conteudo_atividades) foi adicionada ao createFallbackPlan em generatePersonalizedPlan.ts, mas o workflowManager n√£o est√° avan√ßando para ela ap√≥s a conclus√£o da etapa 3 (criar_atividade).

Falha no Renderizamento Condicional: O ProgressiveExecutionCard.tsx e CapabilityCard.tsx n√£o est√£o detectando corretamente quando a capability gerar_conteudo_atividades deve ser renderizada como um novo t√≥pico visual.

Objetivo Final
Garantir que ap√≥s a conclus√£o da Interface de Constru√ß√£o de Atividades (etapa 3), o sistema automaticamente:

Detecte que todas as atividades foram constru√≠das

Avance para a etapa 4 do plano

Renderize o sub-card retangular de gerar_conteudo_atividades abaixo da Interface de Constru√ß√£o

Execute a gera√ß√£o de conte√∫do para cada atividade constru√≠da

Instru√ß√µes de Implementa√ß√£o
PRIORIDADE 1: Corrigir o Fluxo de Avan√ßo Autom√°tico
Arquivo: src/features/schoolpower/interface-chat-producao/chat-input-jota/components/developer-mode/DeveloperModeCard.tsx

Altera√ß√µes necess√°rias:

typescript
// Adicionar listener robusto para o evento de conclus√£o
useEffect(() => {
  const handleConstructionComplete = (event: CustomEvent) => {
    const completedActivities = event.detail?.activities || [];
    
    // Validar se h√° atividades conclu√≠das
    if (completedActivities.length > 0) {
      console.log('üéØ Constru√ß√£o conclu√≠da! Ativando etapa 4...', completedActivities);
      
      // For√ßar avan√ßo para pr√≥xima etapa do plano
      const nextStep = executionPlan.find(step => 
        step.capabilities.some(cap => cap.name === 'gerar_conteudo_atividades')
      );
      
      if (nextStep) {
        // Atualizar status e renderizar pr√≥xima capability
        updateStepStatus(nextStep.step, 'em andamento');
        setCurrentActivities(completedActivities);
      }
    }
  };

  window.addEventListener('construction:all_completed', handleConstructionComplete as EventListener);
  
  return () => {
    window.removeEventListener('construction:all_completed', handleConstructionComplete as EventListener);
  };
}, [executionPlan]);
PRIORIDADE 2: Garantir Renderiza√ß√£o do Sub-Card
Arquivo: src/features/schoolpower/interface-chat-producao/chat-input-jota/components/construction-interface/ConstructionInterface.tsx

Adicionar ap√≥s linha de conclus√£o:

typescript
// Ao finalizar constru√ß√£o de TODAS as atividades
if (allActivitiesComplete) {
  console.log('‚úÖ TODAS atividades constru√≠das! Emitindo evento...');
  
  const completedData = activitiesToBuild.map(act => ({
    id: act.id,
    titulo: act.titulo,
    tipo: act.tipo,
    built_data: act.built_data
  }));
  
  // Emitir evento com dados completos
  window.dispatchEvent(new CustomEvent('construction:all_completed', {
    detail: { 
      activities: completedData,
      timestamp: Date.now()
    }
  }));
  
  // CR√çTICO: Aguardar 500ms antes de permitir pr√≥xima a√ß√£o
  setTimeout(() => {
    setIsReadyForNextStep(true);
  }, 500);
}
PRIORIDADE 3: For√ßar Execu√ß√£o da Capability
Arquivo: src/features/schoolpower/services/generatePersonalizedPlan.ts

Modificar a etapa 4 para ser executada automaticamente:

typescript
{
  step: 4,
  description: "Gerar conte√∫do personalizado para cada atividade constru√≠da",
  capabilities: [
    {
      name: 'gerar_conteudo_atividades',
      categoria: 'GERAR_CONTEUDO',
      importancia: 'CR√çTICO',
      descricao: 'Gerar automaticamente o conte√∫do educacional completo para as atividades',
      parametros_requeridos: ['activitiesData'], // Dados v√™m do evento anterior
      auto_trigger: true, // ‚Üê ADICIONAR ESTA FLAG
      depends_on: 'criar_atividade' // ‚Üê ADICIONAR DEPEND√äNCIA EXPL√çCITA
    }
  ]
}
PRIORIDADE 4: Adicionar Valida√ß√£o de Capability no Renderizador
Arquivo: src/features/schoolpower/interface-chat-producao/chat-input-jota/components/developer-mode/ProgressiveExecutionCard.tsx

Adicionar verifica√ß√£o espec√≠fica:

typescript
// Dentro do map de capabilities
{capabilities.map((capability, idx) => {
  // Verifica√ß√£o especial para gerar_conteudo_atividades
  if (capability.name === 'gerar_conteudo_atividades') {
    console.log('üé® Renderizando ContentGenerationCard com:', completedActivities);
    
    return (
      <div key={`capability-${idx}`} className="mt-4">
        <div className="text-sm text-orange-400 mb-2">
          ‚öôÔ∏è Gerando conte√∫do das atividades...
        </div>
        <ContentGenerationCard 
          activities={completedActivities}
          onComplete={() => updateStepStatus(step, 'completo')}
        />
      </div>
    );
  }
  
  // Renderiza√ß√£o padr√£o para outras capabilities
  return <CapabilityCard key={idx} capability={capability} />;
})}
Plano de Teste
Ap√≥s implementar as corre√ß√µes acima, teste o fluxo completo:

Enviar prompt: "Crie 3 atividades de matem√°tica sobre fra√ß√µes"

Verificar etapas:

Etapa 1: Pesquisa de atividades ‚úÖ

Etapa 2: Decis√£o de quais criar ‚úÖ

Etapa 3: Interface de Constru√ß√£o aparece ‚úÖ

Etapa 4: Sub-card de gerar_conteudo_atividades deve aparecer ‚ö†Ô∏è

Validar logs no console:

üéØ Constru√ß√£o conclu√≠da! Ativando etapa 4...

üé® Renderizando ContentGenerationCard com: [...]

Alternativa de Fallback (Se o problema persistir)
Se ap√≥s as corre√ß√µes acima o sub-card ainda n√£o aparecer, implemente um trigger manual for√ßado:

Adicionar bot√£o tempor√°rio de debug no DeveloperModeCard:

typescript
{/* DEBUG: Bot√£o para for√ßar etapa 4 */}
<button 
  onClick={() => {
    console.log('üîß For√ßando execu√ß√£o da etapa 4...');
    const step4 = executionPlan.find(s => s.step === 4);
    if (step4) {
      updateStepStatus(4, 'em andamento');
      setForceRenderContentGeneration(true);
    }
  }}
  className="px-4 py-2 bg-orange-500 text-white rounded"
>
  DEBUG: For√ßar Gera√ß√£o de Conte√∫do
</button>
Resumo das Corre√ß√µes
Problema	Solu√ß√£o	Arquivo
Evento n√£o capturado	Adicionar listener robusto com valida√ß√£o	DeveloperModeCard.tsx
Fluxo n√£o avan√ßa	Implementar auto_trigger e depends_on	generatePersonalizedPlan.ts
Sub-card n√£o renderiza	Adicionar verifica√ß√£o espec√≠fica no map	ProgressiveExecutionCard.tsx
Timing incorreto	Adicionar delay de 500ms ap√≥s conclus√£o	ConstructionInterface.tsx
