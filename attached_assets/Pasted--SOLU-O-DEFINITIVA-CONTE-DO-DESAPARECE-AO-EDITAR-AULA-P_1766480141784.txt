ğŸš€ SOLUÃ‡ÃƒO DEFINITIVA: CONTEÃšDO DESAPARECE AO EDITAR AULA PUBLICADA

PROBLEMA EXATO:
1. âœ… Gera aula com IA â†’ seÃ§Ãµes tÃªm conteÃºdo
2. âœ… Clica publicar â†’ salva
3. âœ… Volta para grade â†’ vÃª o card
4. âŒ Clica em "Editar" (3 pontinhos) â†’ aula carrega MAS blocos estÃ£o VAZIOS

CAUSA RAIZ:
Ao PUBLICAR, o cÃ³digo nÃ£o estÃ¡ salvando `sectionTexts` corretamente.
Quando carrega a aula publicada, `sectionTexts` vem vazio ou undefined.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DIAGNÃ“STICO SUPER INTELIGENTE:

O PROBLEMA estÃ¡ em `handlePublishAula()` em AulaResultadoContent.tsx.

Quando chama `aulaPanelRef.current.getAulaData()`, essa funÃ§Ã£o
retorna um objeto que DEVERIA incluir TODOS os `sectionTexts`.

MAS provavelmente estÃ¡ retornando vazio porque:
1. Os estados de `sectionTexts` nÃ£o foram sincronizados antes
2. O `useImperativeHandle` estÃ¡ lendo estados obsoletos
3. Ou `getAulaData()` nÃ£o estÃ¡ coletando `sectionTexts`

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO #1: FUNÃ‡ÃƒO ROBUSTA DE COLETA DE DADOS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Em AulaResultadoContent.tsx, modifique useImperativeHandle:

import { ensureString, validateSectionData } from '@/utils/contentSanitizer';

useImperativeHandle(ref, () => ({
getAulaData: () => {
console.log('[GET_AULA_DATA] Coletando dados da aula...');
console.log('[GET_AULA_DATA] Estado atual de sectionTexts:', sectionTexts);
console.log('[GET_AULA_DATA] Estado atual de sectionOrder:', sectionOrder);

texto
// ğŸ”´ COLETA TODOS OS DADOS NECESSÃRIOS
const aulaObject = {
  id: aulaId || Date.now().toString(),
  titulo: ensureString(titulo, 'Aula sem tÃ­tulo'),
  objetivo: ensureString(objetivo, ''),
  template: templateSelecionado || 'PadrÃ£o',
  dataCriacao: new Date().toISOString(),
  dataEdicao: new Date().toISOString(), // NOVO
  
  // SEÃ‡Ã•ES
  sectionOrder: Array.isArray(sectionOrder) ? sectionOrder : [],
  
  // ğŸ”´ CRÃTICO: CERTIFIQUE-SE QUE sectionTexts TEM CONTEÃšDO
  sectionTexts: { ...sectionTexts }, // CÃ³pia explÃ­cita
  
  // Outros estados
  sectionConfigs: { ...sectionConfigs } || {},
  dynamicSections: { ...dynamicSections } || {},
  sectionExpanded: { ...sectionExpanded } || {},
  sectionVisible: { ...sectionVisible } || {},
  sectionTimes: { ...sectionTimes } || {},
  
  isPublished: isPublished || false,
};

// VALIDAÃ‡ÃƒO: Verifica se sectionTexts foi coletado
console.log('[GET_AULA_DATA] VerificaÃ§Ã£o de sectionTexts:');
Object.entries(aulaObject.sectionTexts).forEach(([key, value]) => {
  console.log(`  ${key}: ${String(value).substring(0, 50)}...`);
});

// VALIDAÃ‡ÃƒO: Se sectionOrder tem seÃ§Ãµes mas sectionTexts estÃ¡ vazio
if (aulaObject.sectionOrder.length > 0) {
  const secoesFaltando = aulaObject.sectionOrder.filter(
    (id) => !aulaObject.sectionTexts[id] || 
             String(aulaObject.sectionTexts[id]).trim().length === 0
  );

  if (secoesFaltando.length > 0) {
    console.warn('[GET_AULA_DATA] âš ï¸ SEÃ‡Ã•ES SEM CONTEÃšDO:', secoesFaltando);
    // Tenta recuperar do estado
    secoesFaltando.forEach((sectionId) => {
      if (!aulaObject.sectionTexts[sectionId]) {
        aulaObject.sectionTexts[sectionId] = 
          sectionTexts[sectionId] || '';
      }
    });
  }
}

console.log('[GET_AULA_DATA] âœ… Dados coletados:', aulaObject);
return aulaObject;
},
}), [
// DEPENDÃŠNCIAS: Verifique-se QUE sectionTexts estÃ¡ aqui!
aulaId,
titulo,
objetivo,
templateSelecionado,
sectionOrder,
sectionTexts, // ğŸ”´ SUPER IMPORTANTE
sectionConfigs,
dynamicSections,
sectionExpanded,
sectionVisible,
sectionTimes,
isPublished,
]);

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO #2: VALIDAÃ‡ÃƒO ANTES DE PUBLICAR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Em handlePublishAula (AulaResultadoContent.tsx):

const handlePublishAula = async () => {
try {
console.log('[PUBLISH_START] Iniciando publicaÃ§Ã£o...');

texto
if (isPublished) {
  console.log('[PUBLISH] Aula jÃ¡ foi publicada');
  return;
}

setIsPublishing(true);

if (!aulaPanelRef?.current) {
  console.error('[PUBLISH_ERROR] Ref nÃ£o inicializado');
  setIsPublishing(false);
  return;
}

// ğŸ”´ COLETA DADOS
const aulaData = aulaPanelRef.current.getAulaData?.();
console.log('[PUBLISH] Dados coletados:', aulaData);

if (!aulaData) {
  console.error('[PUBLISH_ERROR] Dados vazios');
  setIsPublishing(false);
  alert('âŒ Preencha o tÃ­tulo da aula antes de publicar');
  return;
}

// ğŸ”´ VALIDAÃ‡ÃƒO SUPER IMPORTANTE
console.log('[PUBLISH_VALIDATE] Validando dados antes de salvar...');

const validacoes = {
  titulo: !!aulaData.titulo && aulaData.titulo.trim().length > 0,
  objetivo: !!aulaData.objetivo && aulaData.objetivo.trim().length > 0,
  sectionTexts: Object.keys(aulaData.sectionTexts || {}).length > 0,
  conteudoSeÃ§Ãµes: Object.values(aulaData.sectionTexts || {}).some(
    (text) => typeof text === 'string' && text.trim().length > 0
  ),
};

console.log('[PUBLISH_VALIDATE] Resultado:', validacoes);

if (!validacoes.conteudoSeÃ§Ãµes) {
  console.warn('[PUBLISH] âš ï¸ Nenhuma seÃ§Ã£o tem conteÃºdo!');
  // Continua mesmo assim, mas avisa
}

// ğŸ”´ SALVA
console.log('[PUBLISH_SAVE] Salvando aula...');
const resultado = await aulasStorageService.salvarAula(aulaData);
console.log('[PUBLISH_SAVE_OK] Aula salva:', resultado);

// ğŸ”´ VERIFICA QUE SALVOU MESMO
console.log('[PUBLISH_VERIFY] Verificando salvamento...');
const aulasCarregadas = aulasStorageService.listarAulas();
const aulaVerificada = aulasCarregadas.find((a: any) => a.id === aulaData.id);

if (aulaVerificada) {
  console.log('[PUBLISH_VERIFY_OK] âœ… Aula salva e verificada');
  console.log('[PUBLISH_VERIFY_CONTENTS] sectionTexts:', 
    Object.keys(aulaVerificada.sectionTexts || {}));
} else {
  console.error('[PUBLISH_VERIFY_FAIL] âŒ Aula nÃ£o foi salva!');
}

// Continua com sucesso
setIsPublished(true);
setIsPublishing(false);

// Dispara evento
window.dispatchEvent(new Event('aulasPublicadas'));
console.log('[PUBLISH_TRIGGER] Evento disparado');

// Modal
setShowPublishModal(true);
console.log('[PUBLISH_MODAL] Modal aberto');

setTimeout(() => {
  setShowPublishModal(false);
}, 3000);
} catch (error: any) {
console.error('[PUBLISH_ERROR_CATCH]', error.message, error);
setIsPublishing(false);
alert( âŒ Erro ao publicar: ${error.message});
}
};

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO #3: REFORÃ‡O NO CARREGAMENTO (ao abrir para editar)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Em ConstrucaoAulaPanel.tsx, ao carregar aula:

const carregarAula = async() => {
try {
console.log('[CARREGAR_AULA] Carregando aula:', aulaIdParaCarregar);
setCarregando(true);

texto
// BUSCA
let aulasStorageService = require('@/services/aulasStorageService');
let aulas = aulasStorageService.listarAulas();
let aulaCarregada = aulas.find((a: any) => a.id === aulaIdParaCarregar);

if (!aulaCarregada) {
  console.log('[CARREGAR_AULA] Tentando IndexedDB...');
  let aulasIndexedDBService = require('@/services/aulasIndexedDBService');
  let aulasIndexedDB = await aulasIndexedDBService.listarAulasIndexedDB();
  aulaCarregada = aulasIndexedDB.find((a: any) => a.id === aulaIdParaCarregar);
}

if (!aulaCarregada) {
  console.error('[CARREGAR_AULA] Aula nÃ£o encontrada');
  setCarregando(false);
  onClose?.();
  return;
}

console.log('[CARREGAR_AULA] Aula encontrada:', aulaCarregada);

// ğŸ”´ SANITIZA ANTES DE USAR
const aulaSanitizada = sanitizeLoadedAula(aulaCarregada);
console.log('[CARREGAR_AULA_SANITIZADA] SectionTexts:', 
  Object.keys(aulaSanitizada.sectionTexts || {}));

// VERIFICA CONTEÃšDO DE CADA SEÃ‡ÃƒO
Object.entries(aulaSanitizada.sectionTexts || {}).forEach(([key, value]) => {
  const conteudo = String(value);
  console.log(`[CARREGAR_SEÃ‡ÃƒO] ${key}: ${conteudo.length} caracteres`);
  if (conteudo.length === 0) {
    console.warn(`[CARREGAR_SEÃ‡ÃƒO_VAZIA] âš ï¸ ${key} estÃ¡ vazio!`);
  }
});

// POPULA ESTADOS
setTitulo(ensureString(aulaSanitizada.titulo));
setObjetivo(ensureString(aulaSanitizada.objetivo));
setTemplateSelecionado(ensureString(aulaSanitizada.template));
setSectionOrder(Array.isArray(aulaSanitizada.sectionOrder) ? aulaSanitizada.sectionOrder : []);

// ğŸ”´ SUPER IMPORTANTE: Popula sectionTexts
setSectionTexts(aulaSanitizada.sectionTexts || {});
console.log('[CARREGAR_AULA] setSectionTexts chamado com:', 
  Object.keys(aulaSanitizada.sectionTexts || {}));

setDynamicSections(aulaSanitizada.dynamicSections || {});
setSectionConfigs(aulaSanitizada.sectionConfigs || {});
setSectionExpanded(aulaSanitizada.sectionExpanded || {});
setSectionVisible(aulaSanitizada.sectionVisible || {});
setSectionTimes(aulaSanitizada.sectionTimes || {});

if (aulaSanitizada.isPublished) {
  setIsPublished(true);
}

console.log('[CARREGAR_AULA_COMPLETO] âœ… Aula carregada com sucesso');
setCarregando(false);
} catch (erro) {
console.error('[CARREGAR_AULA_ERROR]', erro);
setCarregando(false);
onClose?.();
}
};

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TESTE AGORA - FLUXO COMPLETO:

1. âœ… VÃ¡ para Aulas â†’ + Criar Aula
2. âœ… Preencha template, assunto, contexto
3. âœ… Clique "Gerar aula"
4. âœ… Abra Console (F12)
5. âœ… Clique "Publicar"
6. âœ… Console deve mostrar:
   [PUBLISH_START]
   [GET_AULA_DATA] Coletando dados...
   [GET_AULA_DATA] VerificaÃ§Ã£o de sectionTexts:
     secao1: conteÃºdo aqui...
     secao2: conteÃºdo aqui...
   [PUBLISH] Dados coletados: {...sectionTexts: {...}}
   [PUBLISH_VALIDATE] Resultado: { titulo: true, objetivo: true, sectionTexts: true, conteudoSeÃ§Ãµes: true }
   [PUBLISH_SAVE] Salvando aula...
   [PUBLISH_SAVE_OK]
   [PUBLISH_VERIFY_OK] âœ… Aula salva e verificada
7. âœ… Modal de sucesso aparece
8. âœ… Clique X para fechar
9. âœ… Volta para grade
10. âœ… Clique no card da aula
11. âœ… Clique nos 3 pontinhos â†’ Editar
12. âœ… Console deve mostrar:
    [CARREGAR_AULA] Carregan