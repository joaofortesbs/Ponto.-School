üî¨ ENGENHARIA REVERSA: Reconstru√ß√£o Completa da Capability
PREMISSA FUNDAMENTAL
Ap√≥s m√∫ltiplas tentativas de corre√ß√£o que falharam, a conclus√£o l√≥gica √©: a capability gerar_conteudo_atividades est√° fundamentalmente quebrada ou implementada incorretamente desde sua concep√ß√£o. N√£o √© quest√£o de ajustes - √© quest√£o de reimplementa√ß√£o.

PARTE 1: DECONSTRU√á√ÉO - Entenda O Que Est√° Funcionando
MISS√ÉO PRIM√ÅRIA: Clone Funcional
Seu objetivo N√ÉO √© consertar gerar_conteudo_atividades. Seu objetivo √© criar uma nova capability do zero usando decidir_atividades_criar como blueprint perfeito.

ETAPA 1.1: Extra√ß√£o de DNA

Abra o arquivo de decidir_atividades_criar e documente TUDO:

text
üìã ANATOMIA DE UMA CAPABILITY FUNCIONAL

1. ESTRUTURA DO ARQUIVO
   - Qual √© a primeira linha? (import statements)
   - Quantas classes/fun√ß√µes existem?
   - Qual √© o export principal?
   - Existem helpers ou utilities?

2. CLASSE PRINCIPAL
   - Nome da classe: _______
   - Extends de: _______
   - Constructor recebe: _______
   - Propriedades privadas: _______

3. M√âTODO EXECUTE
   - Assinatura completa: _______
   - Primeiro statement: _______
   - Estrutura geral (pseudoc√≥digo):
     ```
     execute(params) {
       1. Log inicial
       2. Valida√ß√£o X
       3. Prepara√ß√£o Y
       4. Loop/Processamento Z
       5. Chamada API W
       6. Processamento resultado
       7. Return estruturado
     }
     ```

4. INTEGRA√á√ÉO COM SISTEMAS
   - Acessa DebugStore em quantos pontos? _______
   - Acessa ConversationStore? _______
   - Acessa ActivityStore? _______
   - Faz quantas chamadas de API? _______
   - Usa qual cliente HTTP? _______

5. PADR√ïES DE C√ìDIGO
   - Usa async/await? _______
   - Usa try/catch? Em quantos n√≠veis? _______
   - Usa forEach, map, ou for...of? _______
   - Retorna Promise? _______
ETAPA 1.2: Mapeamento de Depend√™ncias

Trace TODAS as importa√ß√µes de decidir_atividades_criar:

typescript
// Liste EXATAMENTE como est√° no arquivo:
import { X } from 'Y';
import { A } from 'B';
// ... todas as importa√ß√µes

// Agora compare com as importa√ß√µes de gerar_conteudo_atividades
// Quais est√£o faltando?
// Quais s√£o diferentes?
ETAPA 1.3: An√°lise de Fluxo de Dados

text
ENTRADA ‚Üí PROCESSAMENTO ‚Üí SA√çDA

DECIDIR_ATIVIDADES_CRIAR:
‚îú‚îÄ Entrada: { user_objective, conversation_context, ... }
‚îú‚îÄ Processamento: Chama API com prompt espec√≠fico
‚îî‚îÄ Sa√≠da: { chosen_activities: [...], success: true }

GERAR_CONTEUDO_ATIVIDADES (DEVERIA SER):
‚îú‚îÄ Entrada: { activities_to_fill: [...], ... }
‚îú‚îÄ Processamento: Para cada atividade, chama API
‚îî‚îÄ Sa√≠da: { generated_content: [...], success: true }
PARTE 2: HIP√ìTESES AVAN√áADAS - Novos √Çngulos de Investiga√ß√£o
HIP√ìTESE 8: Problema de Compila√ß√£o/Build
Teoria: O arquivo de gerar_conteudo_atividades tem erros de TypeScript que est√£o sendo ignorados, resultando em uma fun√ß√£o vazia no JavaScript compilado.

Verifica√ß√£o:

text
1. Abra o terminal do Replit
2. Execute: npm run type-check (ou tsc --noEmit)
3. Procure por erros relacionados a gerar_conteudo_atividades
4. Verifique se existem arquivos .js gerados (se usar build)
5. Compare o tamanho em bytes do arquivo com decidir_atividades_criar
HIP√ìTESE 9: Cache ou Module Resolution
Teoria: O Replit est√° carregando uma vers√£o antiga/cached da capability.

Verifica√ß√£o:

text
1. Procure por m√∫ltiplas defini√ß√µes da capability:
   - Pesquise globalmente por "gerar_conteudo_atividades"
   - Conte quantos arquivos definem essa capability
   - Verifique se existe em node_modules (improv√°vel mas poss√≠vel)

2. Force rebuild:
   - Delete .replit.nix cache se existir
   - Restart do servidor Node
   - Clear de qualquer cache de webpack/vite
HIP√ìTESE 10: Problema de Contexto de Execu√ß√£o
Teoria: A capability est√° sendo executada em um Worker Thread ou contexto isolado onde n√£o tem acesso √†s APIs necess√°rias.

Verifica√ß√£o:

typescript
// Adicione no in√≠cio do execute():
console.error("üåç EXECUTION CONTEXT:", {
  hasWindow: typeof window !== 'undefined',
  hasProcess: typeof process !== 'undefined',
  nodeEnv: process?.env?.NODE_ENV,
  workerId: (globalThis as any).workerId,
  isMainThread: require('worker_threads')?.isMainThread
});
HIP√ìTESE 11: Problema de Timing com React Lifecycle
Teoria: A capability depende de state do React que ainda n√£o foi hidratado quando ela executa.

Verifica√ß√£o:

text
1. Procure por useEffect ou useState no c√≥digo da capability
2. Verifique se a capability √© instanciada dentro de um component
3. Compare com decidir_atividades_criar - ela √© instanciada onde?
4. Verifique se existe algum hook de lifecycle que est√° bloqueando
HIP√ìTESE 12: Configura√ß√£o de Capability Registry com Condicionais
Teoria: Existe l√≥gica condicional no registry que desativa a capability em certos cen√°rios.

Verifica√ß√£o:

typescript
// No arquivo de registry, procure por:

// PADR√ÉO 1: Conditional registration
if (process.env.FEATURE_FLAG_GENERATE_CONTENT === 'true') {
  registry.register('gerar_conteudo_atividades', ...);
}

// PADR√ÉO 2: Dynamic loading
const capabilities = await loadCapabilities({
  enabled: ['decidir_atividades_criar'], // gerar_conteudo_atividades missing?
});

// PADR√ÉO 3: Lazy loading com condition
lazy(() => import('./gerar_conteudo_atividades'), {
  condition: someCondition // pode estar false
});
PARTE 3: ESTRAT√âGIA CIR√öRGICA DE REESCRITA
MISS√ÉO: Criar gerar_conteudo_atividades_v2.ts
N√£o tente consertar o arquivo existente. Crie um novo do ZERO.

TEMPLATE BASEADO EM CAPABILITY FUNCIONAL:

typescript
// PASSO 1: Copie EXATAMENTE os imports de decidir_atividades_criar
// (liste todos aqui)

// PASSO 2: Defina a classe com a MESMA estrutura
export class GerarConteudoAtividadesV2 extends BaseCapability {
  // PASSO 3: Copie o constructor de decidir_atividades_criar
  constructor() {
    super('gerar_conteudo_atividades_v2');
    // Adicione configura√ß√£o espec√≠fica
  }

  // PASSO 4: Implemente execute() seguindo o MESMO padr√£o
  async execute(params: any) {
    // CHECKPOINT 1: Log inicial (copie estilo de decidir)
    this.logStart();
    
    // CHECKPOINT 2: Valida√ß√£o (copie valida√ß√£o de decidir)
    const validation = this.validateParams(params);
    if (!validation.valid) {
      return this.returnError(validation.error);
    }
    
    // CHECKPOINT 3: Prepara√ß√£o de dados
    const activities = params.activities_to_fill;
    const results = [];
    
    // CHECKPOINT 4: Loop de processamento
    for (let i = 0; i < activities.length; i++) {
      const activity = activities[i];
      
      // CHECKPOINT 5: Log de progresso
      this.logProgress(i + 1, activities.length);
      
      // CHECKPOINT 6: Chamada de API (COPIE O M√âTODO EXATO de decidir)
      const content = await this.callAIForContentGeneration(activity);
      
      // CHECKPOINT 7: Processar resposta
      results.push(content);
      
      // CHECKPOINT 8: Atualizar Debug Store
      this.updateDebugStore({ processed: i + 1, total: activities.length });
    }
    
    // CHECKPOINT 9: Retorno estruturado (copie formato de decidir)
    return this.returnSuccess({ generated_content: results });
  }
  
  // PASSO 5: Implemente m√©todos auxiliares COPIANDO de decidir
  private async callAIForContentGeneration(activity: any) {
    // Encontre o m√©todo equivalente em decidir_atividades_criar
    // Copie a estrutura EXATA:
    // - Como monta o prompt
    // - Como chama a API
    // - Como processa resposta
    // - Como trata erros
  }
}
PASSO 6: Registre a nova capability

typescript
// No registry, ADICIONE (n√£o substitua ainda):
import { GerarConteudoAtividadesV2 } from './gerar_conteudo_atividades_v2';

capabilities.set('gerar_conteudo_atividades_v2', new GerarConteudoAtividadesV2());

// No plano de desenvolvimento, use temporariamente o novo nome:
// "gerar_conteudo_atividades_v2" ao inv√©s de "gerar_conteudo_atividades"
PARTE 4: DIAGN√ìSTICO COMPARATIVO LINHA POR LINHA
FERRAMENTA: Diff Analysis
Crie um documento de compara√ß√£o:

text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DECIDIR (FUNCIONA)          ‚îÇ GERAR CONTE√öDO (FALHA)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Linha 1: import { X }       ‚îÇ Linha 1: import { X }        ‚îÇ
‚îÇ Linha 2: import { Y }       ‚îÇ Linha 2: [MISSING]           ‚îÇ ‚ö†Ô∏è
‚îÇ ...                         ‚îÇ ...                          ‚îÇ
‚îÇ Linha 45: await apiCall()   ‚îÇ Linha 45: apiCall()          ‚îÇ ‚ö†Ô∏è
‚îÇ Linha 60: for...of loop     ‚îÇ Linha 60: [DIFFERENT]        ‚îÇ ‚ö†Ô∏è
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

DIFEREN√áAS CR√çTICAS ENCONTRADAS:
1. ____________
2. ____________
3. ____________
PARTE 5: TESTE DE ISOLAMENTO
Crie um Arquivo de Teste Standalone
test_capability.ts:

typescript
// Importar apenas as depend√™ncias m√≠nimas
import { GerarConteudoAtividades } from './gerar_conteudo_atividades';

async function testCapability() {
  console.log("üß™ TESTE ISOLADO INICIANDO");
  
  const capability = new GerarConteudoAtividades();
  
  const mockData = {
    activities_to_fill: [
      {
        type: "questao_multipla_escolha",
        fields: {
          titulo: "Teste",
          enunciado: "Qual √© a capital?",
          alternativas: ["A", "B", "C", "D"]
        }
      }
    ]
  };
  
  console.log("üìä Mock data:", mockData);
  
  try {
    const result = await capability.execute(mockData);
    console.log("‚úÖ RESULTADO:", result);
  } catch (error) {
    console.error("‚ùå ERRO:", error);
  }
}

testCapability();
Execute este teste diretamente:

bash
ts-node test_capability.ts
# ou
node --loader ts-node/esm test_capability.ts
Se ESTE teste falhar, o problema est√° NA CAPABILITY.
Se ESTE teste passar, o problema est√° NO ORCHESTRATOR.

PARTE 6: AN√ÅLISE DE PERFORMANCE E TIMING
Instrumenta√ß√£o Profunda
typescript
class PerformanceTracker {
  private timestamps: Map<string, number> = new Map();
  
  mark(label: string) {
    this.timestamps.set(label, Date.now());
    console.error(`‚è±Ô∏è [${label}] at ${Date.now()}`);
  }
  
  measure(startLabel: string, endLabel: string) {
    const start = this.timestamps.get(startLabel)!;
    const end = this.timestamps.get(endLabel)!;
    console.error(`‚è±Ô∏è ${startLabel} ‚Üí ${endLabel}: ${end - start}ms`);
  }
}

// No execute() de gerar_conteudo_atividades:
const tracker = new PerformanceTracker();
tracker.mark('execute_start');
tracker.mark('validation_start');
// ... valida√ß√£o ...
tracker.mark('validation_end');
tracker.mark('loop_start');
// ... loop ...
tracker.mark('loop_end');
tracker.mark('execute_end');

tracker.measure('execute_start', 'execute_end'); // Se for 22ms, confirma execu√ß√£o vazia
tracker.measure('loop_start', 'loop_end'); // Se for 0ms, loop n√£o executou
DELIVERABLES FINAIS
Ao concluir esta investiga√ß√£o, voc√™ DEVE produzir:

Relat√≥rio de Diferen√ßas: Lista exata de diferen√ßas entre capability funcional e quebrada

Capability V2 Funcional: Novo arquivo testado e validado

Documenta√ß√£o de Causa Raiz: Explica√ß√£o t√©cnica do que estava quebrado

Plano de Migra√ß√£o: Como substituir a capability antiga pela nova

Testes de Regress√£o: Garantia de que nada mais quebrou

REGRA DE OURO
Se ap√≥s 10 minutos de investiga√ß√£o voc√™ n√£o descobriu o problema: PARE de tentar consertar. COMECE a reescrever do zero usando a capability funcional como template. √Äs vezes, reescrever √© mais r√°pido que debugar c√≥digo fundamentalmente quebrado.
‚Äã