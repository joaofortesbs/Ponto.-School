‚úÖ Objetivo e Resultado Esperado

Corrigir o erro para que o Modal da Apostila Inteligente exiba as anota√ß√µes exportadas, incluindo o nome da pasta associada (se houver).
a rela√ß√£o entre apostila_anotacoes.pasta_id Defina e apostila_pastas.id como uma chave estrangeira no Supabase.
Atualizar o esquema cache do Supabase para refletir a nova rela√ß√£o.
Ajustar a consulta para carregar as anota√ß√µes de forma robusta, tratando casos em que pasta_id √© null .
Adicionar tratamento de erros claro e mensagens √∫teis para o usu√°rio.
Garanta que o Supabase Realtime continue funcionando para atualiza√ß√µes autom√°ticas no Modal da Apostila.
üõ†Ô∏è Instru√ß√µes para Corre√ß√£o

1. Defina a Chave Estrangeira no Supabase
Para corrigir o erro, precisamos criar uma chave estrangeira entre apostila_anotacoes.pasta_id e apostila_pastas.id . Isso permitir√° que o Supabase reconhe√ßa a rela√ß√£o entre as tabelas.

Passo 1: Acesse o painel do Supabase e v√° para o SQL Editor .
Passo 2: Execute o seguinte comando para adicionar a chave estrangeira:
sql

Copiar
ALTER TABLE apostila_anotacoes
ADD CONSTRAINT fk_pasta_id
FOREIGN KEY (pasta_id)
REFERENCES apostila_pastas (id)
ON DELETE SET NULL;
O ON DELETE SET NULL garante que, se uma pasta for exclu√≠da, o pasta_id nas anota√ß√µes associadas ser√° definido como null , evitando erros de integridade.
Valida√ß√£o:

Ap√≥s executar o comando, v√° para o Table Editor no painel do Supabase e confirme que a tabela apostila_anotacoes agora tem uma chave estrangeira fk_pasta_id associada a apostila_pastas.id .
Execute uma consulta manual para verificar a rela√ß√£o:
sql

Copiar
SELECT * FROM apostila_anotacoes
LEFT JOIN apostila_pastas ON apostila_anotacoes.pasta_id = apostila_pastas.id
LIMIT 1;
Confirme que a consulta retorna dados sem erros.
2. Atualizar o Schema Cache do Supabase
O erro menciona que a rela√ß√£o n√£o foi encontrada no "schema cache". Precisamos for√ßar o Supabase a atualizar o cache para refletir a nova chave estrangeira.

Passo 1: No painel do Supabase, v√° para Configura√ß√µes > API .
Passo 2: Clique em Atualizar API Docs para recarregar o cache do esquema.
Passo Alternativo: Se o problema persistir, v√° para Configura√ß√µes > Geral e clique em Reiniciar Projeto para reiniciar o projeto e recarregar o esquema.
Passo 3 (Opcional): Se voc√™ estiver em um ambiente de desenvolvimento, reinicie o servidor ou a aplica√ß√£o para garantir que o cliente do Supabase (usado no Vibe Code) recarregue o esquema.
Valida√ß√£o:

Ap√≥s atualizar o cache do esquema, execute novamente a consulta manual no painel do Supabase:
sql

Copiar
SELECT * FROM apostila_anotacoes
LEFT JOIN apostila_pastas ON apostila_anotacoes.pasta_id = apostila_pastas.id
LIMIT 1;
Confirme que a consulta funciona sem erros.
3. Ajustar a Consulta para Carregar Anota√ß√µes no Modal da Apostila
Atualize a fun√ß√£o que carrega as anota√ß√µes no Modal da Apostila Inteligente para lidar corretamente com a rela√ß√£o entre apostila_anotacoes e apostila_pastas , tratando casos em que pasta_id √© null .

Fun√ß√£o Atualizada:
Substitui a fun√ß√£o carregarAnotacoesApostila pela seguinte:
JavaScript

Copiar
async function carregarAnotacoesApostila() {
  try {
    // 1. Buscar anota√ß√µes da Apostila com um LEFT JOIN impl√≠cito
    const { data: anotacoes, error } = await supabase
      .from('apostila_anotacoes')
      .select(`
        id,
        user_id,
        pasta_id,
        titulo,
        conteudo,
        modelo_anotacao,
        tags,
        data_criacao,
        data_exportacao,
        origem,
        apostila_pastas!left (
          id,
          nome
        )
      `)
      .eq('user_id', auth.currentUser.uid)
      .order('data_exportacao', { ascending: false });

    if (error) {
      console.error('Erro ao carregar anota√ß√µes:', error.message);
      if (error.code === 'PGRST116') {
        showMessage('Nenhuma anota√ß√£o encontrada. Exporte anota√ß√µes do Caderno para come√ßar.');
      } else if (error.code === '42501') {
        showError('Permiss√£o negada. Verifique suas credenciais e tente novamente.');
      } else {
        showError(`Erro ao carregar anota√ß√µes: ${error.message}`);
      }
      return [];
    }

    if (!anotacoes || anotacoes.length === 0) {
      showMessage('Nenhuma anota√ß√£o encontrada. Exporte anota√ß√µes do Caderno para come√ßar.');
      return [];
    }

    // 2. Ajustar o formato dos dados, garantindo que apostila_pastas seja null se n√£o houver pasta
    const anotacoesFormatadas = anotacoes.map(anotacao => ({
      ...anotacao,
      apostila_pastas: anotacao.apostila_pastas || null,
    }));

    // 3. Atualizar o estado do Modal com as anota√ß√µes
    updateApostilaModal(anotacoesFormatadas);
    return anotacoesFormatadas;

  } catch (err) {
    console.error('Erro inesperado ao carregar anota√ß√µes:', err.message);
    showError('Erro inesperado ao carregar anota√ß√µes. Tente novamente.');
    return [];
  }
}