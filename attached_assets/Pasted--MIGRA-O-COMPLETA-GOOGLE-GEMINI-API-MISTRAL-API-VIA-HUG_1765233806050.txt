=== MIGRAÇÃO COMPLETA: GOOGLE GEMINI API → MISTRAL API VIA HUGGINGFACE ===

INSTRUÇÃO CRÍTICA:
Você é o Vibe Code, um agent de IA avançado responsável pela migração completa da chave API do Google Gemini para a nova chave API do Mistral na plataforma Ponto.School. Execute todos os passos com precisão absoluta, sem erros ou bugs.

---

## FASE 1: IDENTIFICAÇÃO E MAPEAMENTO

1. **SCANNER COMPLETO:**
   - Localize TODAS as ocorrências de "GEMINI_API_KEY" em todos os arquivos do projeto
   - Procure em: .env, .env.local, .env.development, .env.production, replit.nix, config files
   - Identifique todas as variáveis de ambiente relacionadas ao Gemini
   - Mapeie TODAS as funções/módulos que usam a API do Gemini:
     * Geração de atividades educacionais (flashcards, quizzes, testes)
     * Prompt engineering para professores
     * Streaming de respostas
     * Batch processing
     * Cache de respostas
   - Liste cada uso identificado com número de linha e arquivo

2. **ANÁLISE DE DEPENDÊNCIAS:**
   - Verifique se há dependências específicas do Google Gemini (ex: @google/generative-ai)
   - Identifique bibliotecas que precisam ser atualizadas ou substituídas
   - Localize imports de módulos do Gemini

---

## FASE 2: PREPARAÇÃO DO AMBIENTE REPLIT

1. **CRIAR NEW SECRET CORRETAMENTE:**
   - Acesse: Replit → Tools → Secrets
   - Crie novo secret com nome: **HUGGINGFACE_API_KEY**
   - Valor: **hf_oVGZqacPoI00AmNc1Z00gVkKfenD0kaYzg**
   - Confirme que o secret está salvo e acessível
   - Verifique em ambos os ambientes: development e production

2. **CONFIGURAR VARIÁVEIS DE FALLBACK:**
   - Crie também: **MISTRAL_MODEL_NAME** = "mistralai/Mistral-7B-Instruct-v0.1"
   - Crie: **HUGGINGFACE_API_URL** = "https://api-inference.huggingface.co/models"
   - Crie: **API_PROVIDER** = "huggingface" (para sinalizar mudança de provider)

---

## FASE 3: SUBSTITUIÇÃO DE CÓDIGO

1. **ATUALIZE TODOS OS IMPORTS:**
   - Substitua imports do Google Gemini por imports HuggingFace
   - Exemplo: De `const { GoogleGenerativeAI } = require("@google/generative-ai");`
   - Para: `const fetch = require('node-fetch');`

2. **REFATORE TODAS AS FUNÇÕES DE API:**
   - Para cada função que usa Gemini, adapte para usar HuggingFace Inference API
   - Mantenha a mesma assinatura de função (não mude inputs/outputs)
   
   **TEMPLATE DE SUBSTITUIÇÃO:**
// ANTES (Gêmeos)
const { GoogleGenerativeAI } = require("@google/generative-ai");
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-pro" });
const result = await model.generateContent(prompt);

// DEPOIS (Mistral via HuggingFace)
const response = await fetch(
${process.env.HUGGINGFACE_API_URL}/${process.env.MISTRAL_MODEL_NAME},
{
headers: { Authorization: Bearer ${process.env.HUGGINGFACE_API_KEY}},
method: 'POST',
body: JSON.stringify({ inputs: prompt }),
}
);
const result = await response.json();

texto

3. **SUBSTITUTE TODAS AS FUNCIONALIDADES:**
- **Geração de Flashcards:** Adapte prompt engineering para Mistral
- **Geração de Quizzes:** Atualize templates de resposta
- **Geração de Testes:** Refatore parsing de resultados
- **Streaming:** Implemente streaming de HuggingFace se aplicável
- **Tratamento de Erros:** Atualize catch blocks para erros específicos do HF

---

## FASE 4: TRATAMENTO DE DIFERENÇAS API

1. **GEMINI vs MISTRAL - Adapte a resposta:**
- Mistral retorna em formato diferente do Gemini
- Normalize a resposta antes de processar
- Adapte parsing de JSON das atividades geradas
- Verifique se campos como "content", "text", "output" estão corretos

2. **IMPLEMENTAR FALLBACK SEGURO:**
- Se HuggingFace falhar, tente fallback para Mistral local (Ollama)
- Implemente retry logic com exponential backoff
- Log detalhado de falhas e tentativas

---

## FASE 5: VALIDAÇÃO E TESTES

1. **TESTE EM DEVELOPMENT:**
- Rode testes unitários para cada função adaptada
- Teste geração de flashcards com prompt real
- Teste geração de quizzes com várias disciplinas
- Teste streaming e respostas longas
- Valide JSON output das atividades

2. **TESTE EM PRODUCTION:**
- Verifique que secret HUGGINGFACE_API_KEY está acessível
- Execute testes de carga moderada
- Monitore latência e performance
- Valide consistência de dados

3. **TESTES FUNCIONAIS COMPLETOS:**
- ✓ Professor escreve prompt "Criar 5 flashcards sobre fotossíntese"
- ✓ Sistema gera atividades corretamente com Mistral
- ✓ JSON estruturado é retornado e salvo no banco
- ✓ Flashcards aparecem na interface do aluno
- ✓ Sem erros em console ou logs
- ✓ Latência aceitável (<2 segundos para flashcards)
- ✓ Testa em ambiente production

---

## FASE 6: CLEANUP E FINALIZAÇÃO

1. **REMOVA CÓDIGO LEGADO:**
- Delete imports antigos do Gemini
- Remova variáveis não utilizadas de GEMINI_API_KEY
- Limpe dependências antigas se não forem usadas

2. **ATUALIZE DOCUMENTAÇÃO:**
- Documente a mudança em README.md
- Atualize guias de setup para novos desenvolvedores
- Documente diferenças de comportamento entre Gemini e Mistral

3. **VERIFIQUE SEGURANÇA:**
- Confirme que GEMINI_API_KEY foi completamente removido
- Verifique que novo secret está protegido
- Valide que não há hardcoded keys em nenhum arquivo
- Execute scan de segurança

---

## CHECKLIST DE EXECUÇÃO

- [ ] Localizadas TODAS as ocorrências de GEMINI_API_KEY
- [ ] Identificadas TODAS as funções que usam Gemini API
- [ ] Secret HUGGINGFACE_API_KEY criado no Replit
- [ ] Secret está acessível em development E production
- [ ] Todos os imports atualizados para HuggingFace
- [ ] Todas as funções de API adaptadas para Mistral
- [ ] Resposta do Mistral sendo parseada corretamente
- [ ] Atividades geradas com qualidade equivalente a Gemini
- [ ] Testes passando em development
- [ ] Testes passando em production
- [ ] Latência dentro dos limites aceitáveis
- [ ] Nenhum erro nos logs
- [ ] Documentação atualizada
- [ ] Código legado removido
- [ ] Security scan completo executado

---

## OBSERVAÇÕES CRÍTICAS

⚠️ **IMPORTANTE:** 
- Não deixe GEMINI_API_KEY em nenhum arquivo ou commit
- Verifique 2x antes de fazer deploy em production
- Teste offline/fallback em caso de falha do HuggingFace
- Monitore uso de tokens para evitar surpresas de custo

✅ **ESPERADO PÓS-MIGRAÇÃO:**
- Ponto.School funcionando 100% com Mistral
- Qualidade de respostas compatível com Gemini
- Sem bugs ou comportamentos inesperados
- Performance dentro dos limites aceitáveis
- Pronto para escalar para usuários reais

---

FIM DO PROMPT - EXECUTE AGORA!