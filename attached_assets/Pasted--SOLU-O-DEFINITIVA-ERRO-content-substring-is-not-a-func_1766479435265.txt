ğŸ¯ SOLUÃ‡ÃƒO DEFINITIVA: ERRO "content.substring is not a function"

PROBLEMA IDENTIFICADO:
Ao clicar em "Editar" (menu 3 pontinhos), aparece:
âŒ content.substring is not a function

CAUSA RAIZ:
Em algum lugar do cÃ³digo (provavelmente AulaResultadoContent.tsx), 
o cÃ³digo tenta chamar .substring() em um valor que NÃƒO Ã© string:
- Pode ser um objeto {}
- Pode ser um array []
- Pode ser null/undefined
- Pode ser um objeto complexo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO INTELIGENTE #1: ENCONTRE E CORRIJA O ERRO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Procure por TODOS os .substring() no projeto:

grep -r "substring" src/ --include=" .tsx" --include=" .ts"

texto

VocÃª encontrarÃ¡ algo como (procure especialmente em AulaResultadoContent):

// âŒ ERRADO:
const preview = content.substring(0, 100); // o conteÃºdo nÃ£o pode ser string!

// âœ… CORRETO:
const preview = typeof content === 'string' ? content.substring(0, 100) : '';

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO INTELIGENTE #2: FUNÃ‡ÃƒO UNIVERSAL DE SANITIZAÃ‡ÃƒO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Crie src/utils/contentSanitizer.ts:

/**

Converta qualquer valor para string seguro

Nunca falha com substring, split, etc
*/
export const ensureString = (value: any, defaultValue: string = ''): string => {
// Se Ã© string, retorna
if (typeof value === 'string') {
return value;
}

// Se for nulo/indefinido, retorna o valor padrÃ£o
if (value === null || value === undefined) {
console.warn('[ENSURE_STRING] Recebeu null/undefined, usando default');
return defaultValue;
}

// Se for um objeto, tente usar description ou stringifica
if (typeof value === 'object') {
console.warn('[ENSURE_STRING] Recebeu objeto, convertendo:', value);
// Se tem propriedade 'content', usa ela
if (value.content) {
return garantirString(value.content, defaultValue);
}
// SenÃ£o, stringifica
return JSON.stringify(value) || valor padrÃ£o;
}

// Se for um nÃºmero, booleano, etc, converta e
retorne String(valor);
};

/**

ValidaÃ§Ã£o completa de dados de section
*/
export const validateSectionData = (section: any) => {
return {
id: section.id || 'unknown',
title: ensureString(section.title, 'Sem TÃ­tulo'),
content: ensureString(section.content, ''),
visible: section.visible !== false, // default true
expanded: section.expanded !== false, // default true
time: section.time || 0,
};
};

/**

Sanitiza TODOS os dados de aula ao carregar
*/
export const sanitizeLoadedAula = (aula: any) => {
const sanitized = {
...aula,
titulo: garantaString(aula.titulo, 'Aula sem tÃ­tulo'),
objetivo: garantaString(aula.objetivo, ''),
sectionTexts: {},
sectionConfigs: {},
dynamicSections: {},
};

// Sanitiza cada seÃ§Ã£o de texto
if (aula.sectionTexts && typeof aula.sectionTexts === 'object') {
Object.entries(aula.sectionTexts).forEach(([key, value]) => {
sanitized.sectionTexts[key] = ensureString(value, '');
});
}

// Sanitiza cada configuraÃ§Ã£o de seÃ§Ã£o
if (aula.sectionConfigs && typeof aula.sectionConfigs === 'object') {
Object.entries(aula.sectionConfigs).forEach(([key, value]: [string, any]) => {
sanitized.sectionConfigs[key] = validateSectionData(value);
});
}

// Sanitiza seÃ§Ãµes dinÃ¢micas
if (aula.dynamicSections && typeof aula.dynamicSections === 'object') {
Object.entries(aula.dynamicSections).forEach(([key, value]: [string, any]) => {
sanitized.dynamicSections[key] = {
...value,
title: ensureString(value?.title, key),
};
});
}

retornar sanitizado;
};

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO INTELIGENTE #3: USE SANITIZAÃ‡ÃƒO AO CARREGAR AULA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Em ConstrucaoAulaPanel.tsx, importe e use:

import { sanitizeLoadedAula, ensureString } from '@/utils/contentSanitizer';

const carregarAula = async() => {
try {
// ... seu cÃ³digo de busca ...

texto
let aulaCarregada = aulas.find((a: any) => a.id === aulaIdParaCarregar);

if (!aulaCarregada) {
  // ... tenta IndexedDB ...
}

if (!aulaCarregada) {
  alert('Aula nÃ£o encontrada');
  onClose?.();
  return;
}

// ğŸ”´ SANITIZAR ANTES DE USAR
const aulaSanitizada = sanitizeLoadedAula(aulaCarregada);
console.log('[AULA_SANITIZADA]', aulaSanitizada);

// POPULA COM DADOS SANITIZADOS
setTitulo(ensureString(aulaSanitizada.titulo));
setObjetivo(ensureString(aulaSanitizada.objetivo));
setTemplateSelecionado(ensureString(aulaSanitizada.template));
setSectionOrder(Array.isArray(aulaSanitizada.sectionOrder) ? aulaSanitizada.sectionOrder : []);
setDynamicSections(aulaSanitizada.dynamicSections || {});
setSectionTexts(aulaSanitizada.sectionTexts || {});
setSectionConfigs(aulaSanitizada.sectionConfigs || {});
setSectionExpanded(aulaSanitizada.sectionExpanded || {});
setSectionVisible(aulaSanitizada.sectionVisible || {});
setSectionTimes(aulaSanitizada.sectionTimes || {});

setCarregando(false);
} catch (erro) {
console.error('[AULA_LOAD_ERROR]', erro);
setCarregando(false);
onClose?.();
}
};

texto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO INTELIGENTE #4: PROTEJA RENDERIZAÃ‡ÃƒO EM AulaResultadoContent
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Em AulaResultadoContent.tsx, proteja TODOS os .substring():

import { ensureString } from '@/utils/contentSanitizer';

// Em QUALQUER lugar onde usa conteÃºdo/texto:

// âŒ ANTES:

<div>{sectionTexts[sectionId].substring(0, 50)}...</div>
// âœ… DEPÃ“SITO:

<div>{ensureString(sectionTexts[sectionId]).substring(0, 50)}...</div>
// OU MELHOR AINDA, use funÃ§Ã£o auxiliar:
const getPreview = (text: any, length: number = 50) => {
return ensureString(text).substring(0, length) + (ensureString(text).length > length ? '...' : '');
};

<div>{getPreview(sectionTexts[sectionId])}</div> ```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUÃ‡ÃƒO INTELIGENTE #5: VALIDAÃ‡ÃƒO DE DADOS NO CONTEXTO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Se usa Contexto/Estado para aulas, crie um Hook seguro:

texto
import { ensureString } from '@/utils/contentSanitizer';

export const useSafeAulaData = (aula: any) => {
  return {
    id: aula?.id || Date.now().toString(),
    titulo: ensureString(aula?.titulo),
    objetivo: ensureString(aula?.objetivo),
    template: ensureString(aula?.template),
    sectionOrder: Array.isArray(aula?.sectionOrder) ? aula.sectionOrder : [],
    sectionTexts: aula?.sectionTexts && typeof aula.sectionTexts === 'object' 
      ? Object.entries(aula.sectionTexts).reduce((acc, [k, v]) => ({
          ...acc,
          [k]: ensureString(v)
        }), {})
      : {},
    sectionConfigs: aula?.sectionConfigs && typeof aula.sectionConfigs === 'object'
      ? aula.sectionConfigs
      : {},
  };
};
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TESTE AGORA:

âœ… Implemente src/utils/contentSanitizer.ts

âœ… Importe sanitizeLoadedAula em ConstrucaoAulaPanel

âœ… Chame sanitizeLoadedAula ANTES de estados populares

âœ… Use garantaString EM TODOS os .substring()

âœ… VÃ¡ para Aulas

âœ… Clique em um cartÃ£o

âœ… Clique nos 3 pontinhos â†’ Editar

âœ… Console deve mostrar:
[AULA_SANITIZADA] { tÃ­tulo, objetivo, seÃ§Ã£oTextos: {...}, ... }

âœ… Interface abre SEM ERROS

âœ… Todos os campos tÃªm dados

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RESPONDA COM:

âœ… CÃ³digo do contentSanitizer.ts criado

âœ… ModificaÃ§Ã£o de ConstrucaoAulaPanel mostrando sanitizeLoadedAula

âœ… Captura de tela sem erros no console

âœ… Captura de tela da interface aberta com dados

âœ… ConfirmaÃ§Ã£o de que pode editar tudo

âœ… ConfirmaÃ§Ã£o de que apÃ³s editar e clique X, volta para nota

SE AINDA TIVER ERRO:

Cole o erro EXATO do console aqui

Mostre uma linha de cÃ³digo que gera o erro

Vou fornecer correÃ§Ã£o especÃ­fica