fix-apostila-relation.js
Ação : Crie um script funcional para corrigir a relação Apostila, caso ele não exista ou esteja com problemas.
Proposta de script : Crie o arquivo scripts/fix-apostila-relation.js com o seguinte conteúdo:
JavaScript

Copiar
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

// Inicializar o cliente do Supabase
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

async function fixApostilaRelation() {
  console.log('Iniciando correção da relação Apostila...');

  try {
    // 1. Criar tabela apostila_pastas se não existir
    const { error: pastasError } = await supabase.rpc('execute_sql', {
      sql_statement: `
        CREATE TABLE IF NOT EXISTS public.apostila_pastas (
          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
          user_id UUID NOT NULL,
          nome TEXT NOT NULL,
          descricao TEXT,
          data_criacao TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
        );

        ALTER TABLE apostila_pastas ENABLE ROW LEVEL SECURITY;

        CREATE POLICY "Usuários só podem ver suas pastas" ON apostila_pastas
        FOR SELECT
        USING (auth.uid() = user_id);

        CREATE POLICY "Usuários podem inserir suas pastas" ON apostila_pastas
        FOR INSERT
        WITH CHECK (auth.uid() = user_id);

        CREATE POLICY "Usuários podem atualizar suas pastas" ON apostila_pastas
        FOR UPDATE
        USING (auth.uid() = user_id);
      `,
    });

    if (pastasError) {
      throw new Error(`Erro ao criar tabela apostila_pastas: ${pastasError.message}`);
    }

    // 2. Criar tabela apostila_anotacoes se não existir
    const { error: anotacoesError } = await supabase.rpc('execute_sql', {
      sql_statement: `
        CREATE TABLE IF NOT EXISTS public.apostila_anotacoes (
          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
          user_id UUID NOT NULL,
          pasta_id UUID,
          titulo TEXT NOT NULL, texto NOT NULL,
          conteudo TEXT NOT NULL,
          modelo_anotacao TEXT,
          tags TEXT[],
          data_criacao TIMESTAMP WITH TIME ZONE NOT NULL,
          data_exportacao TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          origem TEXT NOT NULL,
          CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE,
          CONSTRAINT fk_pasta_id FOREIGN KEY (pasta_id) REFERENCES apostila_pastas(id) ON DELETE SET NULL
        );

        ALTER TABLE apostila_anotacoes ENABLE ROW LEVEL SECURITY;

        CREATE POLICY "Usuários só podem ver suas anotações" ON apostila_anotacoes
        FOR SELECT
        USING (auth.uid() = user_id);

        CREATE POLICY "Usuários podem inserir suas anotações" ON apostila_anotacoes
        FOR INSERT
        WITH CHECK (auth.uid() = user_id);

        CREATE POLICY "Usuários podem atualizar suas anotações" ON apostila_anotacoes
        FOR UPDATE
        USING (auth.uid() = user_id);
      `,
    });

    if (anotacoesError) {
      throw new Error(`Erro ao criar tabela apostila_anotacoes: ${anotacoesError.message}`);
    }

    console.log('Relação Apostila corrigida com sucesso!');
  } catch (error) {
    console.error('Erro ao corrigir relação Apostila:', error.message);
    process.exit(1);
  }
}

// Executar a função
fixApostilaRelation();
Dependências Necessárias : Certifique-se de que as dependências @supabase/supabase-js e dotenv estão instaladas no projeto:
festança

Copiar
npm install @supabase/supabase-js dotenv
Configurar Variáveis ​​de Ambiente : Crie um arquivo .env na raiz do projeto com as credenciais do Supabase:
texto

Copiar
SUPABASE_URL=<sua_url_do_supabase>
SUPABASE_KEY=<sua_chave_do_supabase>
Substitua <sua_url_do_supabase> e <sua_chave_do_supabase> pelas credenciais do seu projeto Supabase (encontradas em Configurações > API no painel do Supabase).
4. Executar o Comando Corrigido
Ação : Execute o comando corrigido para rodar o script.
Comando :
festança

Copiar
echo "Iniciando correção da relação Apostila..." && node scripts/fix-apostila-relation.js
Validação :
Confirme que o terminal exibe a mensagem "Iniciando correção da relação Apostila..." seguida de "Relação Apostila corrigida com sucesso!".
Verifique no painel do Supabase (no Table Editor ) que as tabelas apostila_pastas e apostila_anotacoes foram criadas com as estruturas e políticas de RLS corretas.